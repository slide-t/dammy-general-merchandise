<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Management</title>
<style>
/* Base */
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f4f6f9;
  color: #222;
}

header {
  background: #001219;
  color: #fff;
  padding: 16px;
  text-align: center;
  font-weight: 700;
  font-size: 1.3rem;
}

.container {
  max-width: 1000px;
  margin: 20px auto;
  padding: 20px;
}

/* Panel */
.panel {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

/* Flex utilities */
.flex-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

@media (max-width: 700px) {
  .grid-2 {
    grid-template-columns: 1fr;
  }
}

/* Form inputs */
input,
select {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
}

/* Buttons */
button {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.btn-add {
  background: #0a9396;
  color: #fff;
}

.btn-add:hover {
  background: #007f89;
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 0.95rem;
}

/* Scrollable table container */
.table-scroll {
  max-height: 300px; /* adjust as needed */
  overflow-y: auto;
  overflow-x: auto;
}

/* Table cells */
th,
td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}

/* Sticky header */
th {
  background: #0077b6;
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 1;
}

/* Low stock alert */
.alert-low {
  background: #fff3cd;
  color: #7a5d00;
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 6px;
  font-weight: bold;
}

  /* Spinner inside button */
.spinner {
  display: inline-block;
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,0.3);
  border-top: 3px solid #fff;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-left: 8px;
  vertical-align: middle;
}

.hidden { display: none; }

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


/* Reusable Water Transparent Modal */
#loginModal{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.3);
  display:flex; justify-content:center; align-items:center;
  z-index:9999;
}
#loginModal .modal-content{
  background:#fff;padding:40px;border-radius:16px;
  width:360px;text-align:center;
  box-shadow:0 8px 24px rgba(0,0,0,0.3);
  position:relative;
}
#loginModal h3{margin-bottom:20px;color:#001219;}
#loginModal input{width:100%;padding:14px;margin:10px 0;border-radius:8px;border:1px solid #ccc;font-size:1rem;}
#loginModal button{
  width:100%; padding:12px; margin-top:15px; border:none; border-radius:50px; font-weight:700; cursor:pointer; font-size:1rem;
}
#loginModal .btn-login{background:#0a9396;color:#fff;}
#loginModal .btn-login:hover{background:#007f89;}
#loginMsg{margin-top:10px;color:red;font-weight:600;}

/* Spinner */
#spinnerOverlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.5);
  display:flex; justify-content:center; align-items:center;
  z-index:10000; display:none;
}
.spinner-loop {
  width:100px; height:100px; border-radius:50%; border:6px solid transparent;
  border-top:6px solid red;
  border-right:6px solid green;
  border-bottom:6px solid blue;
  border-left:6px solid yellow;
  animation:spin 1s linear infinite;
  display:flex; justify-content:center; align-items:center;
}
.spinner-loop img{width:50px;height:50px; animation:spinReverse 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@keyframes spinReverse{0%{transform:rotate(0deg);}100%{transform:rotate(-360deg);}}

#logoutBtn{
  position:fixed; top:70px; right:20px;
  background:#ff5252; color:#fff; border:none; border-radius:25px 0 0 25px; padding:8px 15px 8px 5px;
  width:50px; height:50px; display:flex; justify-content:center; align-items:center;
  cursor:pointer; z-index:9999; transition:transform 0.3s;
}
#logoutBtn:hover{transform:scale(1.2);}
#logoutBtn .tooltip{
  visibility:hidden; position:absolute; top:-28px; background:#ff5252; color:#fff;
  padding:4px 8px; border-radius:6px; font-size:0.8rem; white-space:nowrap;
}
#logoutBtn.showTooltip .tooltip{visibility:visible; animation:zoom 0.6s ease-in-out infinite;}
@keyframes zoom{0%,100%{transform:scale(1);}50%{transform:scale(1.3);}}


  
</style>
</head>
<body>

<header>ðŸ“¦ Stock Management</header>
<div class="container">

<div class="panel">
  <h2>Add New Stock</h2>
  <div class="grid-2">
    <input type="text" id="itemName" placeholder="Item Name">
    <input type="text" id="itemCategory" placeholder="Category">
    <input type="number" id="itemQty" placeholder="Quantity" min="1">
    <input type="number" id="itemPrice" placeholder="Price (â‚¦)" min="1" step="0.01">
  </div>
<!--  <button class="btn-add" id="addStockBtn">Add Stock</button>-->
<div class="grid" style="grid-column: 1 / -1; position:relative;">
  <button id="addStockBtn" class="btn-primary" type="submit">
    <span id="btnText">âž• Add Item</span>
    <span id="btnSpinner" class="spinner hidden"></span>
  </button>
</div>
  
</div>
<div class="panel">
  <h2>Stock List</h2>
  <div id="lowStockAlerts"></div>
  
  <!-- Scrollable table container -->
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Qty</th>
          <th>Price (â‚¦)</th>
        </tr>
      </thead>
      <tbody id="stockTable"></tbody>
    </table>
  </div>
</div>

<!-- Reusable Login Modal -->
<div id="loginModal">
  <div class="modal-content">
    <h3>Staff Login</h3>
    <input type="password" id="staffPassword" placeholder="Enter Password">
    <button class="btn-login" id="staffLoginBtn">Login</button>
    <p id="loginMsg"></p>
  </div>
</div>

<!-- Spinner Overlay -->
<div id="spinnerOverlay">
  <div class="spinner-loop">
    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjxt5Kpv0QeqlUKHX3DftEAfQga4TenQqJPtv81WZQvJkISGgyVClnFtO9AudC9fYtb0KST5EPB2M4wUEfBqbGdt9p6rddDu496oC_qWh71dw5ain_Iunbv8tOq-dLXApV2c4lFbYBd5C34eD39nugn-rlOV590DFgY6Mp3SJ3K0qM43pIARTmeG_03I6c/s320/1000053949.png" alt="Logo">
  </div>
</div>

<!-- Logout Button -->
<button id="logoutBtn">
  <span class="tooltip">Logout</span>
  <i class="fas fa-power-off"></i>
</button>
  
<script>
// --- IndexedDB setup ---
let db;
const request = indexedDB.open("StoreDB", 1);
request.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains("stock")) db.createObjectStore("stock", { keyPath: "barcode" });
  if (!db.objectStoreNames.contains("sales")) db.createObjectStore("sales", { autoIncrement: true });
};
request.onsuccess = e => { db = e.target.result; renderStock(); };
request.onerror = () => alert("DB error");

// --- Generate 8-character barcode ---
function generateBarcode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let b = '';
  for (let i = 0; i < 8; i++) b += chars.charAt(Math.floor(Math.random() * chars.length));
  return b;
}

// --- Elements ---
const addStockBtn = document.getElementById("addStockBtn");
const itemName = document.getElementById("itemName");
const itemCategory = document.getElementById("itemCategory");
const itemQty = document.getElementById("itemQty");
const itemPrice = document.getElementById("itemPrice");

// --- Spinner & Button Text ---
const btnText = document.createElement("span");
btnText.textContent = "âž• Add Item";
addStockBtn.innerHTML = '';
addStockBtn.appendChild(btnText);

const btnSpinner = document.createElement("span");
btnSpinner.className = "spinner hidden";
btnSpinner.style.marginLeft = "8px";
addStockBtn.appendChild(btnSpinner);

// --- Add Stock ---
addStockBtn.addEventListener("click", () => {
  const name = itemName.value.trim();
  const category = itemCategory.value.trim();
  const qty = parseInt(itemQty.value);
  const price = parseFloat(itemPrice.value);

  if (!name || !category || !qty || !price) { alert("âŒ Please fill all fields"); return; }

  // Disable button & show spinner
  addStockBtn.disabled = true;
  btnText.textContent = "Adding...";
  btnSpinner.classList.remove("hidden");

  // Ensure unique barcode
  let barcode;
  function tryAdd() {
    barcode = generateBarcode();
    const tx = db.transaction("stock", "readwrite").objectStore("stock");
    const req = tx.add({ barcode, name, category, qty, price });

    req.onsuccess = () => {
      renderStock();
      // Show confirmation modal
      showConfirmationModal(name, barcode);
    };

    req.onerror = () => {
      // If barcode exists, retry with new one
      tryAdd();
    };
  }
  tryAdd();
});

// --- Confirmation Modal ---
function showConfirmationModal(name, barcode) {
  // Create modal overlay
  const modal = document.createElement("div");
  modal.style.position = "fixed";
  modal.style.top = 0;
  modal.style.left = 0;
  modal.style.width = "100%";
  modal.style.height = "100%";
  modal.style.background = "rgba(0,0,0,0.4)";
  modal.style.display = "flex";
  modal.style.justifyContent = "center";
  modal.style.alignItems = "center";
  modal.style.zIndex = 9999;

  const content = document.createElement("div");
  content.style.background = "#fff";
  content.style.padding = "30px";
  content.style.borderRadius = "12px";
  content.style.textAlign = "center";
  content.style.minWidth = "300px";

  content.innerHTML = `<h3>âœ… Stock Added!</h3>
                       <p>Item: <b>${name}</b><br>Barcode: <b>${barcode}</b></p>
                       <button id="modalOkBtn" style="padding:10px 20px;border:none;background:#0a9396;color:#fff;border-radius:8px;cursor:pointer;margin-top:15px;">OK</button>`;

  modal.appendChild(content);
  document.body.appendChild(modal);

  document.getElementById("modalOkBtn").addEventListener("click", () => {
    document.body.removeChild(modal);
    // Reset form
    itemName.value = "";
    itemCategory.value = "";
    itemQty.value = "";
    itemPrice.value = "";
    itemName.focus();
    // Reset button
    addStockBtn.disabled = false;
    btnText.textContent = "âž• Add Item";
    btnSpinner.classList.add("hidden");
  });
}

// --- Render Stock ---
function renderStock() {
  const tbody = document.getElementById("stockTable");
  const alerts = document.getElementById("lowStockAlerts");
  tbody.innerHTML = "";
  alerts.innerHTML = "";

  const tx = db.transaction("stock", "readonly").objectStore("stock");
  tx.openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if (cursor) {
      const i = cursor.value;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i.name}</td><td>${i.category}</td><td>${i.qty}</td><td>â‚¦${i.price.toFixed(2)}</td>`;
      tbody.appendChild(tr);

      if (i.qty <= 5) {
        const div = document.createElement("div");
        div.className = "alert-low";
        div.textContent = `âš  Low stock: ${i.name} (Qty: ${i.qty})`;
        alerts.appendChild(div);
      }
      cursor.continue();
    }
  };
}
</script>

<script>
// --- Staff password ---
const staffPassword="staff123";

// --- IndexedDB or other initialization here if needed ---

// --- Login Modal ---
const loginModal=document.getElementById("loginModal");
const staffLoginBtn=document.getElementById("staffLoginBtn");
const staffPasswordInput=document.getElementById("staffPassword");
const loginMsg=document.getElementById("loginMsg");
const spinnerOverlay=document.getElementById("spinnerOverlay");

staffLoginBtn.addEventListener("click",()=>{
  const val=staffPasswordInput.value.trim();
  if(val===staffPassword){
    loginMsg.textContent="";
    // Show spinner overlay
    spinnerOverlay.style.display="flex";
    loginModal.style.display="none";
    // Simulate loading 5 seconds
    setTimeout(()=>{
      spinnerOverlay.style.display="none";
      // Here load the page content / enable full page
      alert("âœ… Login successful! Page ready.");
    },5000);
  }else{
    loginMsg.textContent="âŒ Incorrect password";
  }
});

// --- Logout Button ---
const logoutBtn=document.getElementById("logoutBtn");
const tooltip=logoutBtn.querySelector(".tooltip");

logoutBtn.addEventListener("click",logout);

// Show tooltip and zoom effect every 10s
setInterval(()=>{
  logoutBtn.classList.add("showTooltip");
  setTimeout(()=>logoutBtn.classList.remove("showTooltip"),4000);
},10000);

// --- Auto logout ---
let inactivityTimer;
function resetTimer(){
  clearTimeout(inactivityTimer);
  inactivityTimer=setTimeout(logout,5*60*1000); // 5 min staff auto logout
}
['mousemove','keydown','scroll','touchstart'].forEach(evt=>document.addEventListener(evt,resetTimer));
resetTimer();

// --- Logout function ---
function logout(){
  alert("âš  You are logged out!");
  window.location.href="index.html"; // redirect to login modal
}
</script>



  
<script>

const deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
localStorage.setItem("deviceId", deviceId);

// Check if device is disabled
function checkDeviceDisabled(){
  const tx = db.transaction("devices","readonly").objectStore("devices");
  tx.get(deviceId).onsuccess = e=>{
    const dev = e.target.result;
    if(dev && dev.disabled){
      alert("âš  Your device has been disabled by admin!");
      window.location.href = "admin.html"; // redirect to login page
    }
  }
}

// Call on page load
checkDeviceDisabled();

  
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBDAvOznQoQnHhG59eCIJ1X3IHne_Ceudg",
    authDomain: "dammymerchpwa.firebaseapp.com",
    projectId: "dammymerchpwa",
    storageBucket: "dammymerchpwa.firebasestorage.app",
    messagingSenderId: "328994755570",
    appId: "1:328994755570:web:d0ae2c7a95dee3213cd16b",
    measurementId: "G-FY347NE91X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const deviceId = crypto.randomUUID(); // unique per device
  const userName = "Staff"; // optional: you can get from login modal
  const page = window.location.pathname.split("/").pop();

  // Register device
  setDoc(doc(db, "activeDevices", deviceId), {
    user: userName,
    page: page,
    lastActive: Timestamp.now(),
    enabled: true
  });

  // Auto-logout if disabled
  const deviceRef = doc(db, "activeDevices", deviceId);
  onSnapshot(deviceRef, (docSnap) => {
    if (docSnap.exists() && !docSnap.data().enabled) {
      alert("You have been disabled by admin.");
      window.location.href = "admin.html"; // redirect to admin access
    }
  });

  // Update last active timestamp
  let timeout = 5 * 60 * 1000; // 5 mins for staff
  let timer;
  function resetTimer() {
    clearTimeout(timer);
    timer = setTimeout(() => logoutStaff(), timeout);
    setDoc(deviceRef, { lastActive: Timestamp.now() }, { merge: true });
  }
  function logoutStaff() {
    alert("You have been logged out due to inactivity.");
    window.location.href = "admin.html";
  }

  window.onload = resetTimer;
  document.onmousemove = resetTimer;
  document.onkeydown = resetTimer;
</script>
   <iframe src="footer.html" style="width:100%; border:none;"></iframe>     
</body>
</html>
