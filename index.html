<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <link rel="manifest" href="/manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGM- Admin Dashboard</title>
<style>
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#f4f6f9;color:#222;}
header{background:#001219;color:#fff;padding:16px;text-align:center;font-weight:700;font-size:1.3rem;}
.container{max-width:1200px;margin:20px auto;padding:20px;}

/* Modal Overlay */
#loginModal{position:fixed; inset:0; background:rgba(0,0,0,0.3); display:flex; justify-content:center; align-items:flex-start; padding-top:50px; z-index:9999;}
#loginModal .modal-content{background:#fff;padding:30px;border-radius:12px;width:400px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.3);}
#loginModal h3{margin-bottom:15px;color:#001219;}
#loginModal input{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ccc;font-size:1rem;}
#loginModal button{width:100%; padding:12px; margin-top:10px; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:1rem;}
#loginModal .btn-login{background:#0a9396;color:#fff;}
#loginModal .btn-page{background:#ffb703;color:#000;margin-top:5px;}
#loginModal .btn-login:hover{background:#007f89;}
#loginModal .btn-page:hover{background:#fb8500;}
#loginMsg{margin-top:5px;color:red;font-weight:600;}

/* Panels */
.panel{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.95rem;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#0077b6;color:#fff;}
.alert-low{background:#fff3cd;color:#7a5d00;padding:8px 12px;border-radius:6px;margin-bottom:6px;font-weight:bold;}
@media(max-width:700px){.grid-2{grid-template-columns:1fr;}}
.flex-between{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.btn-export{background:#0a9396;color:#fff;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;}
.btn-export:hover{background:#007f89;}
label{display:block;font-weight:600;margin-bottom:4px;color:#001219;}
input[type=date]{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;}
</style>
</head>
<body>

<header>ðŸ›  Admin Dashboard</header>

<div class="container">

  <!-- Login Modal -->
  <div id="loginModal">
    <div class="modal-content">
      <h3>Admin Access</h3>
      <input type="password" id="adminPassword" placeholder="Enter password">
      <button class="btn-login" id="loginBtn">Login to Dashboard</button>
      <button class="btn-page" id="stockBtn">Go to Stock Page</button>
      <button class="btn-page" id="salesBtn">Go to Sales Page</button>
      <p id="loginMsg"></p>
    </div>
  </div>

  <!-- Dashboard Panels -->
  <div id="dashboard" style="display:none;">

    <!-- Stock Panel -->
    <div class="panel">
      <div class="flex-between">
        <h2>Stock Overview</h2>
        <button class="btn-export" id="exportStockPDF">Export PDF</button>
      </div>
      <div id="lowStockAlerts"></div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Barcode</th>
              <th>Name</th>
              <th>Category</th>
              <th>Qty</th>
              <th>Price (â‚¦)</th>
            </tr>
          </thead>
          <tbody id="stockTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Sales Panel -->
    <div class="panel">
      <div class="flex-between">
        <h2>Sales Report</h2>
        <button class="btn-export" id="exportSalesPDF">Export PDF</button>
      </div>
      <div class="grid-2">
        <div>
          <label>From:</label>
          <input type="date" id="fromDate">
        </div>
        <div>
          <label>To:</label>
          <input type="date" id="toDate">
        </div>
      </div>
      <div style="overflow-x:auto;margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Barcode</th>
              <th>Item Name</th>
              <th>Qty</th>
              <th>Price (â‚¦)</th>
              <th>Total (â‚¦)</th>
            </tr>
          </thead>
          <tbody id="salesTable"></tbody>
        </table>
      </div>
    </div>

  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const password="admin123";
let db;

// Open IndexedDB
const request=indexedDB.open("StoreDB",1);
request.onupgradeneeded=e=>{
  db=e.target.result;
  if(!db.objectStoreNames.contains("stock")) db.createObjectStore("stock",{keyPath:"barcode"});
  if(!db.objectStoreNames.contains("sales")) db.createObjectStore("sales",{autoIncrement:true});
};
request.onsuccess=e=>{db=e.target.result;};
request.onerror=()=>alert("DB error");

// Modal buttons
const loginModal=document.getElementById("loginModal");
const dashboard=document.getElementById("dashboard");
document.getElementById("loginBtn").addEventListener("click",()=>{
  const pass=document.getElementById("adminPassword").value;
  if(pass===password){
    loginModal.style.display="none"; dashboard.style.display="block";
    renderStock(); renderSales();
    // auto refresh every 2s
    setInterval(()=>{renderStock(); renderSales();},2000);
  }else document.getElementById("loginMsg").textContent="âŒ Incorrect password";
});
document.getElementById("stockBtn").addEventListener("click",()=>window.location.href="stock.html");
document.getElementById("salesBtn").addEventListener("click",()=>window.location.href="sales.html");

// Render Stock
function renderStock(){
  const tbody=document.getElementById("stockTable");
  const alerts=document.getElementById("lowStockAlerts");
  tbody.innerHTML=""; alerts.innerHTML="";
  const tx=db.transaction("stock","readonly").objectStore("stock");
  tx.openCursor().onsuccess=e=>{
    const cursor=e.target.result;
    if(cursor){
      const i=cursor.value;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i.barcode}</td><td>${i.name}</td><td>${i.category}</td><td>${i.qty}</td><td>â‚¦${i.price.toFixed(2)}</td>`;
      tbody.appendChild(tr);
      if(i.qty<=5){
        const div=document.createElement("div");
        div.className="alert-low";
        div.textContent=`âš  Low stock: ${i.name} (Qty: ${i.qty})`;
        alerts.appendChild(div);
      }
      cursor.continue();
    }
  };
}

// Render Sales
function renderSales(from=null,to=null){
  const tbody=document.getElementById("salesTable");
  tbody.innerHTML="";
  const tx=db.transaction("sales","readonly").objectStore("sales");
  tx.openCursor().onsuccess=e=>{
    const cursor=e.target.result;
    if(cursor){
      const s=cursor.value;
      const date=new Date(s.date);
      const fromDate=from?new Date(from):null;
      const toDate=to?new Date(to):null;
      if((!fromDate || date>=fromDate) && (!toDate || date<=toDate)){
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${date.toLocaleString()}</td><td>${s.barcode}</td><td>${s.name}</td><td>${s.qty}</td><td>â‚¦${s.price.toFixed(2)}</td><td>â‚¦${s.total.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      }
      cursor.continue();
    }
  };
}

// Filter Sales by Date
document.getElementById("fromDate").addEventListener("change",()=>renderSales(document.getElementById("fromDate").value,document.getElementById("toDate").value));
document.getElementById("toDate").addEventListener("change",()=>renderSales(document.getElementById("fromDate").value,document.getElementById("toDate").value));

// Export PDF
document.getElementById("exportStockPDF").addEventListener("click",()=>exportTablePDF("stockTable","Stock_Report"));
document.getElementById("exportSalesPDF").addEventListener("click",()=>exportTablePDF("salesTable","Sales_Report"));

function exportTablePDF(tableId,title){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y=20;
  doc.setFontSize(14); doc.text(title,14,10);
  const table=document.getElementById(tableId);
  for(let r=0;r<table.rows.length;r++){
    let row=table.rows[r]; let rowData=[];
    for(let c=0;c<row.cells.length;c++) rowData.push(row.cells[c].innerText);
    doc.text(rowData.join(" | "),14,y); y+=7;
  }
  doc.save(`${title}.pdf`);
}
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(reg => {
      console.log('Service Worker registered', reg);

      reg.onupdatefound = () => {
        const installingWorker = reg.installing;
        installingWorker.onstatechange = () => {
          if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // New update available
            console.log('New content available, will use when all tabs are closed.');
          }
        };
      };
    })
    .catch(err => console.error('Service Worker registration failed:', err));
}
</script>
<!-- Logout Button -->
<button id="logoutBtn" style="position:fixed;top:10px;right:10px;padding:8px 14px;background:#ff5252;color:#fff;border:none;border-radius:6px;cursor:pointer;z-index:9999;">Logout</button>

<script>
// --- Configuration ---
const isAdminPage = window.location.href.includes("index"); // detect admin page
const logoutTime = isAdminPage ? 10 * 60 * 1000 : 5 * 60 * 1000; // 10 min for admin, 5 min for staff
let inactivityTimer;

// --- Logout Function ---
function logout() {
  alert("âš  You have been logged out due to inactivity.");
  // Redirect to admin access page (login modal page)
  window.location.href = "index.html"; 
}

// --- Reset Timer ---
function resetTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(logout, logoutTime);
}

// --- Monitor Activity ---
['mousemove','keydown','scroll','touchstart'].forEach(evt => {
  document.addEventListener(evt, resetTimer);
});

// --- Initial Timer Start ---
resetTimer();

// --- Logout Button Click ---
document.getElementById("logoutBtn").addEventListener("click", logout);
</script>


  
</body>
</html>
