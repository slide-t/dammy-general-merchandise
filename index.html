<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <link rel="manifest" href="/manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGM- Admin Dashboard</title>
<style>
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#f4f6f9;color:#222;}
header{background:#001219;color:#fff;padding:16px;text-align:center;font-weight:700;font-size:1.3rem;}
.container{max-width:1200px;margin:20px auto;padding:20px;}

/* Modal Overlay */
#loginModal{position:fixed; inset:0; background:rgba(0,0,0,0.3); display:flex; justify-content:center; align-items:flex-start; padding-top:50px; z-index:9999;}
#loginModal .modal-content{background:#fff;padding:30px;border-radius:12px;width:400px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.3);}
#loginModal h3{margin-bottom:15px;color:#001219;}
#loginModal input{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ccc;font-size:1rem;}
#loginModal button{width:100%; padding:12px; margin-top:10px; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:1rem;}
#loginModal .btn-login{background:#0a9396;color:#fff;}
#loginModal .btn-page{background:#ffb703;color:#000;margin-top:5px;}
#loginModal .btn-login:hover{background:#007f89;}
#loginModal .btn-page:hover{background:#fb8500;}
#loginMsg{margin-top:5px;color:red;font-weight:600;}

/* Panels */
.panel {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* Grid inside panel */
.grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

/* Table wrapper for scrollable content */
.panel table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 0.95rem;
}

/* Make tbody scrollable while keeping thead sticky */
.panel table thead th {
  position: sticky;
  top: 0;
  background: #0077b6;
  color: #fff;
  z-index: 2;
}

.panel .table-container {
  max-height: 300px;   /* Adjust scroll height */
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 8px;
}

/* Table cells */
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}

/* Alternate row colors */
.panel tbody tr:nth-child(even) {
  background: #f9f9f9;
}

/* Low stock alert */
.alert-low {
  background: #fff3cd;
  color: #7a5d00;
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 6px;
  font-weight: bold;
}

/* Responsive */
@media(max-width:700px) {
  .grid-2 {
    grid-template-columns:1fr;
  }
  .panel .table-container {
    max-height: 200px;
  }
  th, td {
    font-size: 0.8rem;
    padding: 6px;
  }
}

/* Buttons & labels */
.flex-between {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.btn-export {
  background: #0a9396;
  color: #fff;
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.btn-export:hover {
  background: #007f89;
}

label {
  display:block;
  font-weight:600;
  margin-bottom:4px;
  color:#001219;
}

input[type=date] {
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
  width:100%;
}




</style>
</head>
<body>

<header>üõ† Admin Dashboard</header>

<div class="container">

  <!-- Login Modal -->
  <div id="loginModal">
    <div class="modal-content">
      <h3>Admin Access</h3>
      <input type="password" id="adminPassword" placeholder="Enter password">
      <button class="btn-login" id="loginBtn">Login to Dashboard</button>
      <button class="btn-page" id="stockBtn">Go to Stock Page</button>
      <button class="btn-page" id="salesBtn">Go to Sales Page</button>
      <p id="loginMsg"></p>
    </div>
  </div>
<div class="grid-2" style="margin-bottom:10px;">
  <div>
    <label>From:</label>
    <input type="date" id="stockFromDate">
  </div>
  <div>
    <label>To:</label>
    <input type="date" id="stockToDate">
  </div>
</div>
  
  <!-- Dashboard Panels --
  <div id="dashboard" style="display:none;">
<!-- Stock Panel --
<div class="panel">
  <div class="flex-between">
    <h2>Stock Overview</h2>
    <button class="btn-export" id="exportStockPDF">Export PDF</button>
  </div>
  <div id="lowStockAlerts"></div>
  <div class="table-container">
    <table>
      <thead> ... </thead>
      <tbody id="stockTable"></tbody>
    </table>
  </div>
</div>

<!-- Sales Panel --
<div class="panel">
  <div class="flex-between">
    <h2>Sales Report</h2>
    <button class="btn-export" id="exportSalesPDF">Export PDF</button>
  </div>
  <div class="grid-2"> ... </div>
  <div class="table-container">
    <table>
      <thead> ... </thead>
      <tbody id="salesTable"></tbody>
    </table>
  </div>
</div>
   
  -->
  
  <!-- Admin Panel: Devices -->
<div class="panel">
  <h2>Manage Devices / Users</h2>
  <table>
    <thead>
      <tr>
        <th>Device ID</th>
        <th>Last Login</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="deviceTable"></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const password="admin123";
let db;

// Open IndexedDB
const request=indexedDB.open("StoreDB",1);
request.onupgradeneeded=e=>{
  db=e.target.result;
  if(!db.objectStoreNames.contains("stock")) db.createObjectStore("stock",{keyPath:"barcode"});
  if(!db.objectStoreNames.contains("sales")) db.createObjectStore("sales",{autoIncrement:true});
};
request.onsuccess=e=>{db=e.target.result;};
request.onerror=()=>alert("DB error");

// Modal buttons
const loginModal=document.getElementById("loginModal");
const dashboard=document.getElementById("dashboard");
document.getElementById("loginBtn").addEventListener("click",()=>{
  const pass=document.getElementById("adminPassword").value;
  if(pass===password){
    loginModal.style.display="none"; dashboard.style.display="block";
    renderStock(); renderSales();
    // auto refresh every 2s
    setInterval(()=>{renderStock(); renderSales();},2000);
  }else document.getElementById("loginMsg").textContent="‚ùå Incorrect password";
});
document.getElementById("stockBtn").addEventListener("click",()=>window.location.href="stock.html");
document.getElementById("salesBtn").addEventListener("click",()=>window.location.href="sales.html");

// Render Stock
function renderStock(){
  const tbody=document.getElementById("stockTable");
  const alerts=document.getElementById("lowStockAlerts");
  tbody.innerHTML=""; alerts.innerHTML="";
  const tx=db.transaction("stock","readonly").objectStore("stock");
  tx.openCursor().onsuccess=e=>{
    const cursor=e.target.result;
    if(cursor){
      const i=cursor.value;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i.barcode}</td><td>${i.name}</td><td>${i.category}</td><td>${i.qty}</td><td>‚Ç¶${i.price.toFixed(2)}</td>`;
      tbody.appendChild(tr);
      if(i.qty<=5){
        const div=document.createElement("div");
        div.className="alert-low";
        div.textContent=`‚ö† Low stock: ${i.name} (Qty: ${i.qty})`;
        alerts.appendChild(div);
      }
      cursor.continue();
    }
  };
}

// Render Sales
function renderSales(from=null,to=null){
  const tbody=document.getElementById("salesTable");
  tbody.innerHTML="";
  const tx=db.transaction("sales","readonly").objectStore("sales");
  tx.openCursor().onsuccess=e=>{
    const cursor=e.target.result;
    if(cursor){
      const s=cursor.value;
      const date=new Date(s.date);
      const fromDate=from?new Date(from):null;
      const toDate=to?new Date(to):null;
      if((!fromDate || date>=fromDate) && (!toDate || date<=toDate)){
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${date.toLocaleString()}</td><td>${s.barcode}</td><td>${s.name}</td><td>${s.qty}</td><td>‚Ç¶${s.price.toFixed(2)}</td><td>‚Ç¶${s.total.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      }
      cursor.continue();
    }
  };
}

// --- Stock Totals ---
function updateStockTotals() {
  const tx = db.transaction("stock", "readonly").objectStore("stock");
  let totalValue = 0;
  let totalItemsToday = 0;
  const today = new Date().toISOString().slice(0,10);

  tx.openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if (cursor) {
      const i = cursor.value;
      totalValue += i.qty * i.price;

      if (i.dateAdded?.slice(0,10) === today) totalItemsToday++;

      cursor.continue();
    } else {
      document.getElementById("stockTotals").textContent = 
        `Total Items Stocked Today: ${totalItemsToday} | Total Stock Value: ‚Ç¶${totalValue.toFixed(2)}`;
    }
  };
}

// --- Sales Totals ---
function updateSalesTotals() {
  const tx = db.transaction("sales", "readonly").objectStore("sales");
  let totalSold = 0;
  let totalAmount = 0;

  tx.openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if (cursor) {
      const s = cursor.value;
      totalSold += s.qty;
      totalAmount += s.qty * s.price;
      cursor.continue();
    } else {
      document.getElementById("salesTotals").textContent =
        `Total Items Sold: ${totalSold} | Total Sales Amount: ‚Ç¶${totalAmount.toFixed(2)}`;
    }
  };
}

// Call after rendering tables
function refreshDashboard() {
  renderStock();
  renderSales();
  updateStockTotals();
  updateSalesTotals();
}
  
// Filter Sales by Date
document.getElementById("fromDate").addEventListener("change",()=>renderSales(document.getElementById("fromDate").value,document.getElementById("toDate").value));
document.getElementById("toDate").addEventListener("change",()=>renderSales(document.getElementById("fromDate").value,document.getElementById("toDate").value));

// Export PDF
document.getElementById("exportStockPDF").addEventListener("click",()=>exportTablePDF("stockTable","Stock_Report"));
document.getElementById("exportSalesPDF").addEventListener("click",()=>exportTablePDF("salesTable","Sales_Report"));

function exportTablePDF(tableId,title){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y=20;
  doc.setFontSize(14); doc.text(title,14,10);
  const table=document.getElementById(tableId);
  for(let r=0;r<table.rows.length;r++){
    let row=table.rows[r]; let rowData=[];
    for(let c=0;c<row.cells.length;c++) rowData.push(row.cells[c].innerText);
    doc.text(rowData.join(" | "),14,y); y+=7;
  }
  doc.save(`${title}.pdf`);
}
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(reg => {
      console.log('Service Worker registered', reg);

      reg.onupdatefound = () => {
        const installingWorker = reg.installing;
        installingWorker.onstatechange = () => {
          if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // New update available
            console.log('New content available, will use when all tabs are closed.');
          }
        };
      };
    })
    .catch(err => console.error('Service Worker registration failed:', err));
}
</script>
<!-- Logout Button -->
<button id="logoutBtn" style="position:fixed;top:10px;right:10px;padding:8px 14px;background:#ff5252;color:#fff;border:none;border-radius:6px;cursor:pointer;z-index:9999;">Logout</button>

<script>
// --- Configuration ---
const isAdminPage = window.location.href.includes("index"); // detect admin page
const logoutTime = isAdminPage ? 10 * 60 * 1000 : 5 * 60 * 1000; // 10 min for admin, 5 min for staff
let inactivityTimer;

// --- Logout Function ---
function logout() {
  alert("‚ö† You have been logged out due to inactivity.");
  // Redirect to admin access page (login modal page)
  window.location.href = "index.html"; 
}

// --- Reset Timer ---
function resetTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(logout, logoutTime);
}

// --- Monitor Activity ---
['mousemove','keydown','scroll','touchstart'].forEach(evt => {
  document.addEventListener(evt, resetTimer);
});

// --- Initial Timer Start ---
resetTimer();

// --- Logout Button Click ---
document.getElementById("logoutBtn").addEventListener("click", logout);
</script>

<script>
// Add or update device in IndexedDB
function registerDevice(deviceId){
  const tx = db.transaction("devices", "readwrite").objectStore("devices");
  tx.put({deviceId, lastLogin: new Date(), disabled: false});
}

// Render devices in admin panel
function renderDevices(){
  const tbody = document.getElementById("deviceTable");
  tbody.innerHTML = "";
  const tx = db.transaction("devices","readonly").objectStore("devices");
  tx.openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if(cursor){
      const dev = cursor.value;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${dev.deviceId}</td>
        <td>${new Date(dev.lastLogin).toLocaleString()}</td>
        <td>${dev.disabled ? "Disabled ‚ùå" : "Active ‚úÖ"}</td>
        <td>
          <button onclick="toggleDevice('${dev.deviceId}',${dev.disabled})">
            ${dev.disabled ? "Enable" : "Disable"}
          </button>
        </td>`;
      tbody.appendChild(tr);
      cursor.continue();
    }
  }
}

// Toggle disable
function toggleDevice(deviceId,currentStatus){
  const tx = db.transaction("devices","readwrite").objectStore("devices");
  tx.get(deviceId).onsuccess = e=>{
    const data = e.target.result;
    data.disabled = !currentStatus;
    tx.put(data);
    renderDevices();
  }
}
  
</script>

    <script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBDAvOznQoQnHhG59eCIJ1X3IHne_Ceudg",
    authDomain: "dammymerchpwa.firebaseapp.com",
    projectId: "dammymerchpwa",
    storageBucket: "dammymerchpwa.firebasestorage.app",
    messagingSenderId: "328994755570",
    appId: "1:328994755570:web:d0ae2c7a95dee3213cd16b",
    measurementId: "G-FY347NE91X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const activeDevicesContainer = document.getElementById("deviceList");

  onSnapshot(collection(db, "activeDevices"), (snapshot) => {
    activeDevicesContainer.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const div = document.createElement("div");
      div.textContent = `${data.user} - ${data.page} - ${data.lastActive.toDate().toLocaleString()} - ${data.enabled ? "Active" : "Disabled"}`;
      activeDevicesContainer.appendChild(div);
    });
  });

  async function disableDevice(deviceId) {
    await setDoc(doc(db, "activeDevices", deviceId), { enabled: false }, { merge: true });
  }

  window.disableDevice = disableDevice; // expose globally if needed
</script>
      
    </script>
<!-- Include Font Awesome CDN in your <head> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

<iframe src="footer.html" style="width:100%; border:none;"></iframe>

    
</body>
</html>
