<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Checkout</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f4f6f9; }
  header { background:#001219; color:#fff; padding:15px; text-align:center; font-weight:bold; }
  nav { display:flex; justify-content:center; gap:12px; margin:10px 0; }
  nav a { text-decoration:none; background:#0077b6; color:white; padding:10px 15px; border-radius:6px; }
  nav a:hover { background:#023e8a; }
  .container { max-width:900px; margin:20px auto; padding:20px; background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
  input, select, button { width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:6px; }
  button { cursor:pointer; background:#0077b6; color:white; border:none; font-weight:bold; }
  button:hover { background:#023e8a; }
  table { width:100%; margin-top:15px; border-collapse:collapse; }
  th, td { border:1px solid #ddd; padding:8px; text-align:center; }
  th { background:#0077b6; color:white; }
  .alert { padding:10px; margin-top:10px; border-radius:6px; font-weight:bold; }
  .alert-warning { background:#fff3cd; color:#856404; }
  .alert-danger { background:#f8d7da; color:#721c24; }
  .grid-2 { display:grid; grid-template-columns: 2fr 1fr; gap:10px; }
  @media(max-width:680px){ .grid-2 { grid-template-columns:1fr; } }
</style>
</head>
<body>

<header>üí∞ Sales Checkout</header>

<nav>
  <a href="admin.html">Admin</a>
  <a href="stock.html">Stock</a>
  <a href="sales.html">Sales</a>
</nav>

<div class="container">
  <h2>Sell Item</h2>
  <div class="grid-2">
    <div>
      <label>Scan Barcode (USB scanner) or type manually</label>
      <input id="barcodeInput" type="text" placeholder="Focus here and scan..." autocomplete="off">
      <small>USB scanners usually submit Enter automatically</small>
    </div>
    <div>
      <label>Quantity</label>
      <input id="saleQty" type="number" min="1" value="1">
    </div>
  </div>
  <button id="sellBtn">üíµ Checkout</button>

  <h2>Sales Records</h2>
  <div id="alerts"></div>
  <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th>Barcode</th>
          <th>Name</th>
          <th>Qty</th>
          <th>Price (‚Ç¶)</th>
          <th>Total (‚Ç¶)</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="salesTable"></tbody>
    </table>
  </div>
</div>

<script>
let db;
const request = indexedDB.open("StoreDB",1);

request.onupgradeneeded = e => {
  db = e.target.result;
  if(!db.objectStoreNames.contains("stock")){
    db.createObjectStore("stock",{keyPath:"barcode"});
  }
  if(!db.objectStoreNames.contains("sales")){
    db.createObjectStore("sales",{keyPath:"id", autoIncrement:true});
  }
};

request.onsuccess = e => {
  db = e.target.result;
  renderSales();
};

request.onerror = ()=>alert("DB error");

// Format currency
function formatN(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

// Process Sale
const barcodeInput = document.getElementById("barcodeInput");
const saleQty = document.getElementById("saleQty");
const sellBtn = document.getElementById("sellBtn");

sellBtn.addEventListener("click", ()=>{ processSale(barcodeInput.value.trim(), parseInt(saleQty.value)||1); });

barcodeInput.addEventListener("keypress", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    processSale(barcodeInput.value.trim(), parseInt(saleQty.value)||1);
  }
});

function processSale(code, qty){
  if(!code){ alert("Enter or scan barcode"); return; }

  const tx = db.transaction(["stock","sales"],"readwrite");
  const stockStore = tx.objectStore("stock");
  const salesStore = tx.objectStore("sales");

  const getReq = stockStore.get(code);
  getReq.onsuccess = function(){
    const item = getReq.result;
    if(!item){ alert("‚ùå Item not found"); return; }
    if(item.qty<qty){ alert(`‚ùå Not enough stock. Available: ${item.qty}`); return; }

    item.qty -= qty;
    stockStore.put(item);

    const saleRecord = {
      barcode:item.barcode,
      name:item.name,
      qty:qty,
      price:item.price,
      total:item.price*qty,
      date:new Date().toLocaleString()
    };
    salesStore.add(saleRecord);

    renderSales();
    barcodeInput.value="";
    saleQty.value=1;
    barcodeInput.focus();

    if(item.qty<=5){
      alert(`‚ö† Low stock: ${item.name} only ${item.qty} left!`);
    } else {
      console.log(`Sold ${qty} x ${item.name} (‚Ç¶${formatN(qty*item.price)})`);
    }
  };
}

function renderSales(){
  const tbody=document.getElementById("salesTable");
  tbody.innerHTML="";
  const alertsDiv = document.getElementById("alerts");
  alertsDiv.innerHTML="";

  const tx = db.transaction(["sales","stock"],"readonly");
  const salesStore = tx.objectStore("sales");
  const stockStore = tx.objectStore("stock");

  salesStore.openCursor().onsuccess = e=>{
    const cursor = e.target.result;
    if(cursor){
      const s = cursor.value;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${s.barcode}</td><td>${s.name}</td><td>${s.qty}</td><td>‚Ç¶${formatN(s.price)}</td><td>‚Ç¶${formatN(s.total)}</td><td>${s.date}</td>`;
      tbody.appendChild(tr);
      cursor.continue();
    }
  };
}
</script>
</body>
</html>
