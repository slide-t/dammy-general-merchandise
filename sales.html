<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales</title>
<style>
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#f4f6f9;color:#222;}
header{background:#001219;color:#fff;padding:16px;text-align:center;font-weight:700;font-size:1.3rem;}
.container{max-width:1200px;margin:20px auto;padding:10px;}
.panel{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.95rem;}
th,td{border:1px solid #ddd;padding:10px;text-align:center;}
th{background:#0077b6;color:#fff;}
input{padding:10px;border-radius:6px;border:1px solid #ccc;margin-bottom:10px;width:100%;}
button{padding:12px 20px;border:none;border-radius:8px;background:#0a9396;color:#fff;cursor:pointer;margin-top:5px;}
button:hover{background:#007f89;}
.flex-between{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
@media(max-width:700px){.flex-between{flex-direction:column;align-items:flex-start;}}
</style>
</head>
<body>

<header>üí∞ Sales / Checkout</header>
<div class="container">

  <div class="panel">
    <h2>Checkout</h2>
    <input type="text" id="barcodeInput" placeholder="Scan / Enter Barcode">
    <input type="number" id="qtyInput" placeholder="Quantity" min="1">
    <button id="addSaleBtn">Add to Sale</button>
    <p id="saleMsg"></p>
  </div>

  <div class="panel">
    <div class="flex-between">
      <h2>Current Sales</h2>
      <button id="printReceipt">Print Receipt</button>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Barcode</th>
            <th>Name</th>
            <th>Qty</th>
            <th>Price (‚Ç¶)</th>
            <th>Total (‚Ç¶)</th>
          </tr>
        </thead>
        <tbody id="salesTable"></tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// IndexedDB
let db;
const request=indexedDB.open("StoreDB",1);
request.onupgradeneeded=e=>{
  db=e.target.result;
  if(!db.objectStoreNames.contains("stock")) db.createObjectStore("stock",{keyPath:"barcode"});
  if(!db.objectStoreNames.contains("sales")) db.createObjectStore("sales",{autoIncrement:true});
};
request.onsuccess=e=>{db=e.target.result;};

// Add sale
document.getElementById("addSaleBtn").addEventListener("click",()=>{
  const barcode=document.getElementById("barcodeInput").value.trim();
  const qty=parseInt(document.getElementById("qtyInput").value);
  if(!barcode || isNaN(qty)){document.getElementById("saleMsg").textContent="‚ùå Fill all fields"; return;}
  const tx=db.transaction("stock","readonly").objectStore("stock");
  tx.get(barcode).onsuccess=e=>{
    const item=e.target.result;
    if(!item){document.getElementById("saleMsg").textContent="‚ùå Item not found"; return;}
    if(item.qty<qty){document.getElementById("saleMsg").textContent="‚ùå Not enough stock"; return;}
    const total=item.price*qty;
    // save sale
    const saleTx=db.transaction("sales","readwrite").objectStore("sales");
    saleTx.add({barcode,itemName:item.name,qty,price:item.price,total,date:new Date(),name:item.name});
    document.getElementById("saleMsg").textContent="‚úÖ Sale added";
    document.getElementById("barcodeInput").value="";
    document.getElementById("qtyInput").value="";
    renderSales();
    // update stock
    const stockTx=db.transaction("stock","readwrite").objectStore("stock");
    stockTx.get(barcode).onsuccess=e=>{
      const data=e.target.result; data.qty-=qty;
      stockTx.put(data);
    }
  };
});

// Render current sales
function renderSales(){
  const tbody=document.getElementById("salesTable");
  tbody.innerHTML="";
  const tx=db.transaction("sales","readonly").objectStore("sales");
  tx.openCursor().onsuccess=e=>{
    const cursor=e.target.result;
    if(cursor){
      const s=cursor.value;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${s.barcode}</td><td>${s.name}</td><td>${s.qty}</td><td>‚Ç¶${s.price.toFixed(2)}</td><td>‚Ç¶${s.total.toFixed(2)}</td>`;
      tbody.appendChild(tr);
      cursor.continue();
    }
  };
}

// Print receipt
document.getElementById("printReceipt").addEventListener("click",()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y=20; doc.setFontSize(14); doc.text("Receipt",14,10);
  const table=document.getElementById("salesTable");
  let grandTotal=0;
  for(let r=0;r<table.rows.length;r++){
    let row=table.rows[r];
    let rowData=[];
    for(let c=0;c<row.cells.length;c++) rowData.push(row.cells[c].innerText);
    doc.text(rowData.join(" | "),14,y); y+=7;
    grandTotal+=parseFloat(row.cells[4].innerText.replace("‚Ç¶",""));
  }
  doc.text("Grand Total: ‚Ç¶"+grandTotal.toFixed(2),14,y+5);
  doc.save("Receipt.pdf");
}
);
</script>
</body>
</html>
