<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales / Checkout</title>
<style>
  body{margin:0;font-family:Arial,sans-serif;background:#f4f6f9;}
  header{background:#001219;color:#fff;padding:15px;text-align:center;font-weight:bold;}
  .container{max-width:980px;margin:20px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);}
  h2{margin-bottom:10px;color:#001219;}
  input,button{padding:10px;margin:5px 0;border-radius:6px;border:1px solid #ccc;width:100%;}
  button{cursor:pointer;font-weight:bold;background:#0077b6;color:#fff;border:none;}
  button:hover{background:#023e8a;}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  @media(max-width:700px){.grid-2{grid-template-columns:1fr;}}
  table{width:100%;border-collapse:collapse;margin-top:15px;}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;}
  th{background:#0077b6;color:#fff;}
  #receipt{border:1px solid #ccc;padding:15px;margin-top:20px;border-radius:10px;background:#fefefe;}
</style>
</head>
<body>

<header>üíµ Sales / Checkout</header>

<div class="container">
  <section>
    <h2>Scan Item / Enter Barcode</h2>
    <div class="grid-2">
      <input type="text" id="barcodeInput" placeholder="Scan barcode or type manually" autocomplete="off">
      <input type="number" id="qtyInput" min="1" value="1" placeholder="Quantity">
    </div>
    <button id="addBtn">‚ûï Add to Cart</button>
    <button id="checkoutBtn">üí≥ Checkout & Print</button>
  </section>

  <section>
    <h2>Cart</h2>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr><th>Barcode</th><th>Name</th><th>Qty</th><th>Price (‚Ç¶)</th><th>Total (‚Ç¶)</th></tr>
        </thead>
        <tbody id="cartTable"></tbody>
      </table>
      <p id="cartTotal" style="font-weight:bold;margin-top:10px;">Total: ‚Ç¶0.00</p>
    </div>
  </section>

  <section id="receipt" style="display:none;"></section>

  <section style="margin-top:20px;">
    <button onclick="window.location.href='stock.html'">üì¶ Go to Stock</button>
    <button onclick="window.location.href='admin.html'">üõ† Admin Dashboard</button>
  </section>
</div>

<script>
let db;
const request = indexedDB.open("StoreDB",1);
request.onsuccess = e=>{db=e.target.result;};
request.onerror = ()=>alert("DB error");

let cart=[];

function formatN(n){return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}

function updateCart(){
  const tbody=document.getElementById("cartTable");
  tbody.innerHTML="";
  let total=0;
  cart.forEach(item=>{
    const t=item.qty*item.price;
    total+=t;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${item.barcode}</td><td>${item.name}</td><td>${item.qty}</td><td>‚Ç¶${formatN(item.price)}</td><td>‚Ç¶${formatN(t)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("cartTotal").textContent=`Total: ‚Ç¶${formatN(total)}`;
}

document.getElementById("addBtn").addEventListener("click",()=>{
  const code=document.getElementById("barcodeInput").value.trim();
  const qty=parseInt(document.getElementById("qtyInput").value,10)||1;
  if(!code){alert("Enter or scan a barcode"); return;}
  const tx=db.transaction("stock","readonly").objectStore("stock");
  let found=false;
  tx.get(code).onsuccess=e=>{
    const item=e.target.result;
    if(!item){alert("‚ùå Item not found"); return;}
    if(item.qty<qty){alert(`‚ùå Not enough stock. Available: ${item.qty}`); return;}
    // Add to cart
    const existing=cart.find(c=>c.barcode===code);
    if(existing){existing.qty+=qty;} else {cart.push({barcode:item.barcode,name:item.name,price:item.price,qty:qty});}
    updateCart();
  };
  document.getElementById("barcodeInput").value="";
  document.getElementById("qtyInput").value="1";
  document.getElementById("barcodeInput").focus();
});

// Checkout
document.getElementById("checkoutBtn").addEventListener("click",()=>{
  if(cart.length===0){alert("Cart is empty"); return;}
  const txStock=db.transaction("stock","readwrite").objectStore("stock");
  const txSales=db.transaction("sales","readwrite").objectStore("sales");
  const now=new Date().toISOString();
  let receiptHTML=`<h3>Receipt</h3><p>Date: ${new Date().toLocaleString()}</p><table border="1" cellspacing="0" cellpadding="4"><tr><th>Barcode</th><th>Name</th><th>Qty</th><th>Price (‚Ç¶)</th><th>Total (‚Ç¶)</th></tr>`;
  let totalAmount=0;
  cart.forEach(item=>{
    const total=item.qty*item.price;
    totalAmount+=total;
    receiptHTML+=`<tr><td>${item.barcode}</td><td>${item.name}</td><td>${item.qty}</td><td>‚Ç¶${formatN(item.price)}</td><td>‚Ç¶${formatN(total)}</td></tr>`;
    // Update stock
    txStock.get(item.barcode).onsuccess=e=>{
      const stockItem=e.target.result;
      stockItem.qty-=item.qty;
      txStock.put(stockItem);
    };
    // Save sale
    txSales.add({barcode:item.barcode,name:item.name,qty:item.qty,price:item.price,total, date:now});
  });
  receiptHTML+=`</table><p style="font-weight:bold;">Total Paid: ‚Ç¶${formatN(totalAmount)}</p>`;
  const receiptDiv=document.getElementById("receipt");
  receiptDiv.innerHTML=receiptHTML;
  receiptDiv.style.display="block";
  cart=[];
  updateCart();
  // Print receipt
  setTimeout(()=>{window.print();},200);
});
</script>

</body>
</html>
